<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ stock_symbol }}</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f7fa;
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 30px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2.5rem;
    }

    .back-link {
      display: inline-block;
      margin-top: 15px;
      color: #fff;
      text-decoration: underline;
      font-weight: bold;
    }

    .content {
      padding: 30px;
    }

    /* ==================== TOAST NOTIFICATIONS ==================== */
    #messages-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 420px;
      width: 90%;
    }

    .message-alert {
      position: relative;
      padding: 16px 45px 16px 20px;
      margin-bottom: 12px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      font-weight: 500;
      font-size: 1.05rem;
      opacity: 0;
      transform: translateX(120%);
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      border-left: 6px solid;
    }

    .message-alert.show {
      opacity: 1;
      transform: translateX(0);
    }

    .message-alert.success {
      background-color: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }

    .message-alert.error {
      background-color: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    .message-alert.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border-left-color: #17a2b8;
    }

    .close-btn {
      position: absolute;
      top: 50%;
      right: 16px;
      transform: translateY(-50%);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
      line-height: 1;
    }

    .close-btn:hover {
      opacity: 1;
    }

    /* Clean Model Accuracy Card */
    .accuracy-card {
      margin: 40px 0;
      padding: 35px;
      background-color: #f8f9fc;
      border-radius: 14px;
      border: 1px solid #e0e6ed;
      text-align: center;
    }

    .metrics-grid {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .metric-item {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
      min-width: 180px;
      flex: 1;
      max-width: 250px;
    }

    .metric-value {
      font-size: 2.4rem;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .metric-label {
      font-size: 1.1rem;
      color: #555;
      font-weight: 500;
    }

    .accuracy-hint {
      margin-top: 20px;
      font-size: 1.05rem;
      color: #666;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .metrics-grid {
        flex-direction: column;
        gap: 20px;
      }

      .metric-item {
        max-width: none;
      }
    }

    /* ==================== REST OF STYLES ==================== */
    .charts-row {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .chart-box {
      flex: 1;
      min-width: 300px;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      background-color: #fafafa;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    .chart-box h2 {
      text-align: center;
      margin-top: 0;
      color: #2c3e50;
    }

    .chart-box img {
      width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      cursor: zoom-in;
      transition: transform 0.3s ease;
    }

    .chart-box img:hover {
      transform: scale(1.02);
    }

    /* Lightbox Modal for Full-Screen Image */
    .lightbox {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      cursor: zoom-out;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
    }

    .lightbox.active {
      display: flex;
    }

    .summary-box {
      text-align: center;
      padding: 20px;
      margin: 30px 0;
      border-radius: 10px;
      font-size: 1.4rem;
      font-weight: bold;
    }

    .strong-buy {
      background-color: #d4edda;
      color: #155724;
    }

    .buy {
      background-color: #e8f5e8;
      color: #2d862d;
    }

    .neutral {
      background-color: #fff3cd;
      color: #856404;
    }

    .sell {
      background-color: #ffe6e6;
      color: #c53030;
    }

    .strong-sell {
      background-color: #f8d7da;
      color: #721c24;
    }

    .signals-table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }

    th {
      background-color: #3498db;
      color: white;
      padding: 14px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .signal-strong-buy {
      background-color: #d4edda;
      font-weight: bold;
      color: #155724;
    }

    .signal-buy {
      background-color: #e8f5e8;
      color: #2d862d;
    }

    .signal-hold {
      background-color: #fffbe6;
      color: #856404;
    }

    .signal-sell {
      background-color: #ffe6e6;
      color: #c53030;
    }

    .signal-strong-sell {
      background-color: #f8d7da;
      font-weight: bold;
      color: #721c24;
    }

    .train-section {
      text-align: center;
      margin: 40px 0;
      padding: 30px;
      background-color: #f0f8ff;
      border-radius: 10px;
    }

    button {
      padding: 16px 36px;
      font-size: 1.3rem;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    #loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      font-size: 1.5rem;
    }

    #loading-text {
      margin-top: 1rem;
      font-size: 1.2rem;
      text-align: center;
      white-space: pre-line;
    }

    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 900px) {
      .charts-row {
        flex-direction: column;
      }

      h1 {
        font-size: 2rem;
      }

      #messages-container {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }

    /* Chat FAB */
    .chat-fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: #6c5ce7;
      color: white;
      padding: 15px 25px;
      border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      font-weight: bold;
      text-decoration: none;
      z-index: 2000;
      transition: transform 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-fab:hover {
      transform: scale(1.05);
    }

    /* Cancel Button in Overlay */
    #cancel-training-btn {
      margin-top: 20px;
      background-color: #e74c3c;
      padding: 10px 20px;
      font-size: 1rem;
      border: 2px solid white;
    }

    #cancel-training-btn:hover {
      background-color: #c0392b;
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loading-overlay">
    <div class="spinner"></div>
    <p>Training {{ stock_symbol }} model...<br>Please wait 30‚Äì90 seconds.</p>
    <pre id="loading-text"></pre>
    <button type="button" id="cancel-training-btn">Cancel & Revert</button>
  </div>

  <!-- Toast Messages Container -->
  <div id="messages-container">
    {% if messages %}
    {% for message in messages %}
    <div class="message-alert {{ message.tags }} show" data-autoclose="6000">
      <span class="message-text">{{ message }}</span>
      <span class="close-btn">&times;</span>
    </div>
    {% endfor %}
    {% endif %}
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox">
    <img id="lightbox-img" src="" alt="Full Screen Chart" />
  </div>

  <div class="container">
    <header>
      <h1>{{ stock_symbol }} Buy/Sell Signals</h1>
      <a href="{% url 'welcome' %}" class="back-link">‚Üê Back to Stock Selection</a>
    </header>

    <div class="content">
      <!-- Charts -->
      <div class="charts-row">
        {% if confusion_image %}
        <div class="chart-box">
          <h2>Ensemble Confusion Matrix</h2>
          <img src="{{ confusion_image }}" alt="Confusion Matrix" class="zoomable-img" />
        </div>
        {% else %}
        <div class="chart-box">
          <p><em>Train model to generate confusion matrix</em></p>
        </div>
        {% endif %}

        {% if signals_test_image %}
        <div class="chart-box">
          <h2>Ensemble Buy/Sell Signals (Test Period)</h2>
          <img src="{{ signals_test_image }}" alt="Buy/Sell Signals" class="zoomable-img" />
        </div>
        {% else %}
        <div class="chart-box">
          <p><em>Train model to generate signals chart</em></p>
        </div>
        {% endif %}

        {% if candlestick_image %}
        <div class="chart-box">
          <h2>Recent Price Trends (Candlestick)</h2>
          <img src="{{ candlestick_image }}" alt="Candlestick Chart" class="zoomable-img" />
          <!-- Backtest Performance Metrics (Responsive with rem units) -->
          <!-- <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f0f8ff, #e6f2ff); border-radius: 0.75rem; text-align: center; box-shadow: 0 0.25rem 0.9375rem rgba(0,0,0,0.08);">
              <h3 style="margin: 0 0 1.5rem 0; color: #2c3e50; font-size: 1.5rem;">Backtest Performance Metrics</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(12.5rem, 1fr)); gap: 1.5rem;">
                <div class="metric-item" style="padding: 1.5rem; background: white; border-radius: 0.625rem; box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.05);">
                  <div class="metric-value" style="font-size: 2.5rem; color: {% if backtest_metrics.sharpe_ratio > 1 %}#28a745{% elif backtest_metrics.sharpe_ratio > 0 %}#f39c12{% else %}#e74c3c{% endif %};">
                    {{ backtest_metrics.sharpe_ratio|default:"N/A"|floatformat:4 }}
                  </div>
                  <div class="metric-label" style="font-size: 1.1rem; color: #555; margin-top: 0.5rem;">Sharpe Ratio</div>
                </div>
                <div class="metric-item" style="padding: 1.5rem; background: white; border-radius: 0.625rem; box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.05);">
                  <div class="metric-value" style="font-size: 2.5rem; color: #e74c3c;">
                    {{ backtest_metrics.max_drawdown|default:"N/A"|floatformat:2 }}%
                  </div>
                  <div class="metric-label" style="font-size: 1.1rem; color: #555; margin-top: 0.5rem;">Max Drawdown</div>
                </div>
                <div class="metric-item" style="padding: 1.5rem; background: white; border-radius: 0.625rem; box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.05);">
                  <div class="metric-value" style="font-size: 2.5rem; color: #3498db;">
                    {{ backtest_metrics.exposure|default:"N/A"|floatformat:2 }}%
                  </div>
                  <div class="metric-label" style="font-size: 1.1rem; color: #555; margin-top: 0.5rem;">Market Exposure</div>
                </div>
              </div>
              
            </div> -->
        </div>
        {% else %}
        <div class="chart-box">
          <p><em>Train the model to generate equity curve and performance metrics</em></p>
        </div>
        {% endif %}

        {% if indicators_comparison_image %}
        <div class="chart-box">
          <h2>Comparison of Technical Indicators</h2>
          <img src="{{ indicators_comparison_image }}" alt="Feature Importance" class="zoomable-img" />
        </div>
        {% else %}
        <div class="chart-box">
          <p><em>Train model to generate feature importance</em></p>
        </div>
        {% endif %}
      </div>

      <!-- Model Accuracy Metrics -->
      {% if ensemble_accuracy is not none %}
      <div class="accuracy-card">
        <h2 style="text-align:center; margin-bottom:25px; color:#2c3e50;">
          Model Accuracy Metrics
        </h2>
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-value">{{ ensemble_accuracy|floatformat:2 }}</div>
            <div class="metric-label">Ensemble Accuracy</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{{ ensemble_balanced_accuracy|floatformat:2 }}</div>
            <div class="metric-label">Ensemble Balanced Accuracy</div>
          </div>
        </div>
        <p class="accuracy-hint">
          Higher values indicate better directional prediction performance.
        </p>
      </div>
      {% endif %}

      <!-- Overall Summary -->
      {% if forecast_signals %}
      <div class="summary-box {{ summary_class }}">
        {{ overall_summary }}
      </div>

      <!-- Forecast Signals Table -->
      <h2 style="text-align:center;">30-Day Trading Signals</h2>
      <div class="signals-table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Signal</th>
            </tr>
          </thead>
          <tbody>
            {% for item in forecast_signals %}
            <tr>
              <td>{{ item.date }}</td>
              <td class="signal-{{ item.signal|lower|slugify }}">{{ item.signal }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Train Model -->
      <div class="train-section">
        <h2>Retrain AI Model for {{ stock_symbol }}</h2>
        <p>Update predictions with latest data</p>
        <form method="post" id="train-form">
          {% csrf_token %}
          <input type="hidden" name="train_model" value="1">
          <button type="submit" id="train-btn">Start Training Model</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Loading Overlay Logic
    const form = document.getElementById('train-form');
    const overlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const btn = document.getElementById('train-btn');
    const cancelBtn = document.getElementById('cancel-training-btn');

    form.addEventListener('submit', () => {
      overlay.style.display = 'flex';
      btn.disabled = true;
      btn.textContent = 'Training in Progress...';
      loadingText.textContent = 'Initializing pipeline...';
    });

    cancelBtn.addEventListener('click', () => {
      if (confirm('Stop waiting for training? (Server process may continue in background)')) {
        window.stop(); // Stops the POST request
        overlay.style.display = 'none';
        btn.disabled = false;
        btn.textContent = 'Start Training Model';
        loadingText.textContent = '';
      }
    });

    // Simulate streaming progress (since real streaming not possible in Django)
    // You can enhance this later with AJAX polling if needed
    let progressMessages = [
      "--- Starting Prediction Pipeline ---",
      "Fetched dataset",
      "Indicators added and labels generated",
      "Data split into training and testing sets",
      "LSTM model training in progress...",
      "LSTM model trained",
      "XGBoost and Random Forest models trained",
      "Ensemble predictions generated",
      "Generating backtest results",
      "Generating future predictions",
      "Saving plots",
      "Pipeline Complete. Refreshing results..."
    ];

    let index = 0;
    const interval = setInterval(() => {
      if (index < progressMessages.length) {
        loadingText.textContent += progressMessages[index] + '\n';
        index++;
      } else {
        clearInterval(interval);
      }
    }, 8000);  // Adjust timing to match average training phases

    window.addEventListener('load', () => {
      overlay.style.display = 'none';
      btn.disabled = false;
      btn.textContent = 'Start Training Model';
    });

    // Toast Notifications Logic
    document.addEventListener('DOMContentLoaded', function () {
      const alerts = document.querySelectorAll('.message-alert');

      alerts.forEach(alert => {
        alert.classList.add('show');

        const timeout = alert.getAttribute('data-autoclose') || 6000;
        const autoCloseTimer = setTimeout(() => closeAlert(alert), timeout);

        const closeBtn = alert.querySelector('.close-btn');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            clearTimeout(autoCloseTimer);
            closeAlert(alert);
          });
        }
      });

      function closeAlert(alert) {
        alert.classList.remove('show');
        setTimeout(() => {
          if (alert.parentNode) alert.parentNode.removeChild(alert);
        }, 6000);
      }
    });

    // Lightbox for Full-Screen Images
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const images = document.querySelectorAll('.zoomable-img');

    images.forEach(img => {
      img.addEventListener('click', () => {
        lightboxImg.src = img.src;
        lightbox.classList.add('active');
      });
    });

    lightbox.addEventListener('click', () => {
      lightbox.classList.remove('active');
    });
  </script>
  <a href="{% url 'chat' %}" class="chat-fab">
    <span>üí¨</span> Ask AI Advisor
  </a>
</body>

</html>